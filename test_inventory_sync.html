<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste - Sincroniza√ß√£o de Invent√°rio</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #1a1a2e;
            color: #eee;
        }
        .container {
            background: #16213e;
            padding: 20px;
            border-radius: 10px;
            margin: 10px 0;
        }
        button {
            background: #0f3460;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 5px;
            cursor: pointer;
        }
        button:hover {
            background: #e94560;
        }
        .log {
            background: #0a0a0a;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            margin: 10px 0;
        }
        .success { color: #4CAF50; }
        .error { color: #f44336; }
        .info { color: #2196F3; }
        .warning { color: #ff9800; }
    </style>
</head>
<body>
    <h1>üîÑ Teste de Sincroniza√ß√£o de Invent√°rio</h1>
    
    <div class="container">
        <h3>Controles de Teste</h3>
        <button onclick="testInventorySync()">üîÑ Testar Sincroniza√ß√£o</button>
        <button onclick="addTestItem()">‚ûï Adicionar Item de Teste</button>
        <button onclick="useTestItem()">üéØ Usar Item de Teste</button>
        <button onclick="showLocalInventory()">üì¶ Mostrar Invent√°rio Local</button>
        <button onclick="clearLocalStorage()">üóëÔ∏è Limpar localStorage</button>
        <button onclick="simulateConflict()">‚ö†Ô∏è Simular Conflito</button>
    </div>
    
    <div class="container">
        <h3>Log de Atividades</h3>
        <div id="log" class="log"></div>
        <button onclick="clearLog()">üßπ Limpar Log</button>
    </div>
    
    <div class="container">
        <h3>Estado do Invent√°rio</h3>
        <div id="inventory-status"></div>
    </div>

    <!-- Incluir depend√™ncias -->
    <script>
        // Configurar Supabase simulado para teste
        window.supabase = {
            from: () => ({
                select: () => ({ data: [], error: null }),
                insert: () => ({ data: [], error: null }),
                update: () => ({ data: [], error: null }),
                eq: function() { return this; },
                order: function() { return this; }
            })
        };
        
        // Classe RankingManager simplificada para teste
        class RankingManager {
            constructor() {
                this.currentUser = null;
            }
            
            setCurrentUser(user) {
                this.currentUser = user;
            }
            
            getCurrentUser() {
                return this.currentUser;
            }
        }
        
        // Classe InventorySync simplificada para teste
        class InventorySync {
            constructor() {
                this.syncInProgress = false;
            }
            
            async syncInventory(playerId) {
                console.log(`Sincronizando invent√°rio para jogador ${playerId}`);
                return {
                    success: true,
                    conflictsResolved: 0,
                    itemsSynced: this.getLocalInventory(playerId).length
                };
            }
            
            getLocalInventory(playerId) {
                const key = `inventory_${playerId}`;
                const data = localStorage.getItem(key);
                return data ? JSON.parse(data) : [];
            }
            
            async addItemToInventory(playerId, item) {
                const inventory = this.getLocalInventory(playerId);
                inventory.push(item);
                const key = `inventory_${playerId}`;
                localStorage.setItem(key, JSON.stringify(inventory));
                
                return { success: true };
            }
            
            async useItemFromInventory(playerId, itemId) {
                const inventory = this.getLocalInventory(playerId);
                const item = inventory.find(i => i.item_id === itemId && i.uses_remaining > 0);
                
                if (!item) {
                    return { success: false, error: 'Item n√£o encontrado ou sem usos' };
                }
                
                item.uses_remaining -= 1;
                const key = `inventory_${playerId}`;
                localStorage.setItem(key, JSON.stringify(inventory));
                
                return {
                    success: true,
                    usesRemaining: item.uses_remaining
                };
            }
            
            hasItemInInventory(playerId, itemId) {
                const inventory = this.getLocalInventory(playerId);
                return inventory.some(item => 
                    item.item_id === itemId && 
                    (!item.uses_remaining || item.uses_remaining > 0)
                );
            }
        }
        
        // Classe Shop simplificada para teste
        class Shop {
            constructor(rankingManager) {
                this.rankingManager = rankingManager;
                this.inventorySync = new InventorySync();
            }
        }
        
        // Disponibilizar classes globalmente
        window.RankingManager = RankingManager;
        window.InventorySync = InventorySync;
        window.Shop = Shop;
    </script>

    <script>
        // Configurar usu√°rio de teste
        const testUser = {
            id: 'test_user_123',
            username: 'test_user',
            coins: 1000
        };

        // Inicializar sistemas
        const rankingManager = new RankingManager();
        rankingManager.setCurrentUser(testUser);
        
        const shop = new Shop(rankingManager);
        const inventorySync = shop.inventorySync;

        // Fun√ß√£o para log
        function log(message, type = 'info') {
            const logElement = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const className = type;
            logElement.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
            logElement.scrollTop = logElement.scrollHeight;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        // Testar sincroniza√ß√£o completa
        async function testInventorySync() {
            log('üîÑ Iniciando teste de sincroniza√ß√£o...', 'info');
            
            try {
                // Sincronizar invent√°rio
                const result = await inventorySync.syncInventory(testUser.id);
                
                if (result.success) {
                    log('‚úÖ Sincroniza√ß√£o bem-sucedida!', 'success');
                    log(`üìä Conflitos resolvidos: ${result.conflictsResolved || 0}`, 'info');
                    log(`üì¶ Itens sincronizados: ${result.itemsSynced || 0}`, 'info');
                } else {
                    log(`‚ùå Erro na sincroniza√ß√£o: ${result.error}`, 'error');
                }
                
                updateInventoryStatus();
            } catch (error) {
                log(`üí• Erro inesperado: ${error.message}`, 'error');
            }
        }

        // Adicionar item de teste
        async function addTestItem() {
            log('‚ûï Adicionando item de teste...', 'info');
            
            const testItem = {
                id: Date.now(),
                item_id: 'test_item_' + Date.now(),
                player_id: testUser.id,
                item_name: 'Item de Teste',
                item_category: 'test',
                uses_remaining: 3,
                is_permanent: false,
                purchased_at: new Date().toISOString()
            };
            
            try {
                const result = await inventorySync.addItemToInventory(testUser.id, testItem);
                
                if (result.success) {
                    log(`‚úÖ Item adicionado: ${testItem.item_name}`, 'success');
                } else {
                    log(`‚ùå Erro ao adicionar item: ${result.error}`, 'error');
                }
                
                updateInventoryStatus();
            } catch (error) {
                log(`üí• Erro inesperado: ${error.message}`, 'error');
            }
        }

        // Usar item de teste
        async function useTestItem() {
            log('üéØ Procurando item para usar...', 'info');
            
            const inventory = inventorySync.getLocalInventory(testUser.id);
            const testItem = inventory.find(item => item.item_id.startsWith('test_item_') && item.uses_remaining > 0);
            
            if (!testItem) {
                log('‚ö†Ô∏è Nenhum item de teste dispon√≠vel para usar', 'warning');
                return;
            }
            
            try {
                const result = await inventorySync.useItemFromInventory(testUser.id, testItem.item_id);
                
                if (result.success) {
                    log(`‚úÖ Item usado: ${testItem.item_name} (${result.usesRemaining} usos restantes)`, 'success');
                } else {
                    log(`‚ùå Erro ao usar item: ${result.error}`, 'error');
                }
                
                updateInventoryStatus();
            } catch (error) {
                log(`üí• Erro inesperado: ${error.message}`, 'error');
            }
        }

        // Mostrar invent√°rio local
        function showLocalInventory() {
            log('üì¶ Carregando invent√°rio local...', 'info');
            
            const inventory = inventorySync.getLocalInventory(testUser.id);
            
            if (inventory.length === 0) {
                log('üì≠ Invent√°rio vazio', 'info');
            } else {
                log(`üì¶ ${inventory.length} itens no invent√°rio:`, 'info');
                inventory.forEach((item, index) => {
                    const uses = item.uses_remaining ? ` (${item.uses_remaining} usos)` : ' (permanente)';
                    log(`  ${index + 1}. ${item.item_name}${uses}`, 'info');
                });
            }
            
            updateInventoryStatus();
        }

        // Limpar localStorage
        function clearLocalStorage() {
            log('üóëÔ∏è Limpando localStorage...', 'warning');
            
            const key = `inventory_${testUser.id}`;
            localStorage.removeItem(key);
            
            log('‚úÖ localStorage limpo', 'success');
            updateInventoryStatus();
        }

        // Simular conflito
        async function simulateConflict() {
            log('‚ö†Ô∏è Simulando conflito de dados...', 'warning');
            
            // Adicionar item apenas no localStorage
            const localItem = {
                id: Date.now(),
                item_id: 'conflict_item_local',
                player_id: testUser.id,
                item_name: 'Item Local (Conflito)',
                item_category: 'test',
                uses_remaining: 5,
                is_permanent: false,
                purchased_at: new Date().toISOString()
            };
            
            const inventory = inventorySync.getLocalInventory(testUser.id);
            inventory.push(localItem);
            localStorage.setItem(`inventory_${testUser.id}`, JSON.stringify(inventory));
            
            log('üì¶ Item adicionado apenas localmente', 'info');
            
            // Tentar sincronizar para detectar conflito
            await testInventorySync();
        }

        // Atualizar status do invent√°rio
        function updateInventoryStatus() {
            const statusElement = document.getElementById('inventory-status');
            const inventory = inventorySync.getLocalInventory(testUser.id);
            
            let html = `<strong>üìä Status do Invent√°rio:</strong><br>`;
            html += `üì¶ Total de itens: ${inventory.length}<br>`;
            
            if (inventory.length > 0) {
                html += `<br><strong>Itens:</strong><br>`;
                inventory.forEach((item, index) => {
                    const uses = item.uses_remaining ? ` (${item.uses_remaining} usos)` : ' (permanente)';
                    html += `${index + 1}. ${item.item_name}${uses}<br>`;
                });
            }
            
            statusElement.innerHTML = html;
        }

        // Limpar log
        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }

        // Inicializar
        document.addEventListener('DOMContentLoaded', () => {
            log('üöÄ Sistema de teste inicializado', 'success');
            log(`üë§ Usu√°rio de teste: ${testUser.username} (ID: ${testUser.id})`, 'info');
            updateInventoryStatus();
        });
    </script>
</body>
</html>