<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Migra√ß√£o do Sistema de Skins</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #1a1a1a;
            color: #fff;
        }
        .section {
            background: #2a2a2a;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            border-left: 4px solid #4ECDC4;
        }
        .success {
            border-left-color: #51cf66;
            background: #2a4a2a;
        }
        .warning {
            border-left-color: #ffd43b;
            background: #4a4a2a;
        }
        .error {
            border-left-color: #ff6b6b;
            background: #4a2a2a;
        }
        button {
            background: #4ECDC4;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        button:hover {
            background: #45b7aa;
        }
        button.danger {
            background: #ff6b6b;
        }
        button.danger:hover {
            background: #ff5252;
        }
        .log {
            background: #000;
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
            margin-top: 10px;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 15px 0;
        }
        .stat-card {
            background: #333;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #4ECDC4;
        }
        .stat-label {
            font-size: 12px;
            color: #aaa;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <h1>üîÑ Migra√ß√£o do Sistema de Skins</h1>
    
    <div class="section">
        <h2>üìã Objetivo da Migra√ß√£o</h2>
        <p>Esta ferramenta ir√°:</p>
        <ul>
            <li>‚úÖ Consolidar dados de <code>activeSkin_*</code> para <code>selectedSkin_*</code></li>
            <li>üóëÔ∏è Remover campos duplicados e obsoletos</li>
            <li>üîß Corrigir dados corrompidos ou inv√°lidos</li>
            <li>üìä Gerar relat√≥rio de migra√ß√£o</li>
        </ul>
    </div>

    <div class="section">
        <h2>üîç An√°lise Atual</h2>
        <button onclick="analyzeCurrentState()">Analisar Estado Atual</button>
        <div class="stats" id="current-stats"></div>
        <div id="analysis-log" class="log"></div>
    </div>

    <div class="section">
        <h2>üöÄ Executar Migra√ß√£o</h2>
        <button onclick="runMigration()">Executar Migra√ß√£o Completa</button>
        <button onclick="runMigrationDryRun()">Simula√ß√£o (Dry Run)</button>
        <div id="migration-log" class="log"></div>
    </div>

    <div class="section">
        <h2>üßπ Limpeza Manual</h2>
        <button class="danger" onclick="clearAllActiveSkins()">Remover Todos os activeSkin_*</button>
        <button class="danger" onclick="clearAllSkinData()">Limpar TODOS os Dados de Skin</button>
        <div id="cleanup-log" class="log"></div>
    </div>

    <div class="section">
        <h2>‚úÖ Verifica√ß√£o P√≥s-Migra√ß√£o</h2>
        <button onclick="verifyMigration()">Verificar Integridade</button>
        <div id="verification-log" class="log"></div>
    </div>

    <script>
        function log(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            const timestamp = new Date().toLocaleTimeString();
            const prefix = {
                'info': '‚ÑπÔ∏è',
                'success': '‚úÖ',
                'warning': '‚ö†Ô∏è',
                'error': '‚ùå'
            }[type] || '‚ÑπÔ∏è';
            
            element.textContent += `${timestamp} ${prefix} ${message}\n`;
            element.scrollTop = element.scrollHeight;
        }
        
        function clearLog(elementId) {
            document.getElementById(elementId).textContent = '';
        }
        
        function updateStats(stats) {
            const statsContainer = document.getElementById('current-stats');
            statsContainer.innerHTML = Object.entries(stats).map(([key, value]) => `
                <div class="stat-card">
                    <div class="stat-number">${value}</div>
                    <div class="stat-label">${key}</div>
                </div>
            `).join('');
        }
        
        // Analisar estado atual
        window.analyzeCurrentState = function() {
            clearLog('analysis-log');
            log('analysis-log', 'Iniciando an√°lise do localStorage...');
            
            const stats = {
                'Total de Chaves': 0,
                'activeSkin_*': 0,
                'selectedSkin_*': 0,
                'Usu√°rios √önicos': 0,
                'Dados Corrompidos': 0
            };
            
            const activeSkins = new Map();
            const selectedSkins = new Map();
            const corruptedKeys = [];
            const users = new Set();
            
            // Analisar todas as chaves
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                stats['Total de Chaves']++;
                
                if (key.startsWith('activeSkin_')) {
                    stats['activeSkin_*']++;
                    const userId = key.replace('activeSkin_', '');
                    users.add(userId);
                    
                    try {
                        const data = JSON.parse(localStorage.getItem(key));
                        activeSkins.set(userId, data);
                        log('analysis-log', `activeSkin encontrado para usu√°rio ${userId}: ${data.skinId}`);
                    } catch (error) {
                        stats['Dados Corrompidos']++;
                        corruptedKeys.push(key);
                        log('analysis-log', `Dados corrompidos em ${key}`, 'error');
                    }
                }
                
                if (key.startsWith('selectedSkin_')) {
                    stats['selectedSkin_*']++;
                    const userId = key.replace('selectedSkin_', '');
                    users.add(userId);
                    
                    try {
                        const data = JSON.parse(localStorage.getItem(key));
                        selectedSkins.set(userId, data);
                        log('analysis-log', `selectedSkin encontrado para usu√°rio ${userId}: ${data.skinId}`);
                    } catch (error) {
                        stats['Dados Corrompidos']++;
                        corruptedKeys.push(key);
                        log('analysis-log', `Dados corrompidos em ${key}`, 'error');
                    }
                }
            }
            
            stats['Usu√°rios √önicos'] = users.size;
            updateStats(stats);
            
            // Analisar conflitos
            log('analysis-log', '\nüîç Analisando conflitos...');
            let conflicts = 0;
            
            for (const userId of users) {
                const active = activeSkins.get(userId);
                const selected = selectedSkins.get(userId);
                
                if (active && selected) {
                    if (active.skinId !== selected.skinId) {
                        conflicts++;
                        log('analysis-log', `‚ö†Ô∏è CONFLITO usu√°rio ${userId}: active=${active.skinId}, selected=${selected.skinId}`, 'warning');
                    } else {
                        log('analysis-log', `‚úÖ Usu√°rio ${userId}: dados sincronizados (${active.skinId})`, 'success');
                    }
                } else if (active && !selected) {
                    log('analysis-log', `üìã Usu√°rio ${userId}: apenas activeSkin (${active.skinId}) - MIGRA√á√ÉO NECESS√ÅRIA`, 'warning');
                } else if (!active && selected) {
                    log('analysis-log', `‚úÖ Usu√°rio ${userId}: apenas selectedSkin (${selected.skinId}) - OK`, 'success');
                }
            }
            
            log('analysis-log', `\nüìä Resumo: ${conflicts} conflitos encontrados`);
            log('analysis-log', `üóëÔ∏è ${corruptedKeys.length} chaves corrompidas para limpeza`);
        };
        
        // Executar migra√ß√£o
        window.runMigration = function() {
            clearLog('migration-log');
            log('migration-log', 'üöÄ Iniciando migra√ß√£o completa...');
            
            const migrationResults = {
                migrated: 0,
                cleaned: 0,
                errors: 0
            };
            
            try {
                // Fase 1: Migrar activeSkin para selectedSkin
                log('migration-log', '\nüìã Fase 1: Migrando activeSkin ‚Üí selectedSkin');
                
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    
                    if (key && key.startsWith('activeSkin_')) {
                        const userId = key.replace('activeSkin_', '');
                        const selectedSkinKey = `selectedSkin_${userId}`;
                        
                        try {
                            const activeData = JSON.parse(localStorage.getItem(key));
                            const existingSelected = localStorage.getItem(selectedSkinKey);
                            
                            if (!existingSelected) {
                                // Migrar activeSkin para selectedSkin
                                const migratedData = {
                                    skinId: activeData.skinId,
                                    skinFile: activeData.skinFile,
                                    skinName: activeData.skinName || activeData.skinId,
                                    selectedAt: activeData.setAt || new Date().toISOString(),
                                    migratedFrom: 'activeSkin'
                                };
                                
                                localStorage.setItem(selectedSkinKey, JSON.stringify(migratedData));
                                log('migration-log', `‚úÖ Migrado usu√°rio ${userId}: ${activeData.skinId}`, 'success');
                                migrationResults.migrated++;
                            } else {
                                log('migration-log', `‚ö†Ô∏è selectedSkin j√° existe para usu√°rio ${userId}, mantendo`, 'warning');
                            }
                            
                            // Remover activeSkin ap√≥s migra√ß√£o
                            localStorage.removeItem(key);
                            migrationResults.cleaned++;
                            
                        } catch (error) {
                            log('migration-log', `‚ùå Erro ao migrar ${key}: ${error.message}`, 'error');
                            migrationResults.errors++;
                            
                            // Remover dados corrompidos
                            localStorage.removeItem(key);
                            migrationResults.cleaned++;
                        }
                    }
                }
                
                // Fase 2: Limpar dados corrompidos
                log('migration-log', '\nüßπ Fase 2: Limpando dados corrompidos');
                
                const keysToCheck = [];
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key && key.includes('Skin')) {
                        keysToCheck.push(key);
                    }
                }
                
                keysToCheck.forEach(key => {
                    try {
                        const data = localStorage.getItem(key);
                        JSON.parse(data); // Testar se √© JSON v√°lido
                    } catch (error) {
                        log('migration-log', `üóëÔ∏è Removendo dados corrompidos: ${key}`, 'warning');
                        localStorage.removeItem(key);
                        migrationResults.cleaned++;
                    }
                });
                
                log('migration-log', `\nüéâ Migra√ß√£o conclu√≠da!`);
                log('migration-log', `üìä Resultados:`);
                log('migration-log', `  ‚Ä¢ ${migrationResults.migrated} skins migradas`);
                log('migration-log', `  ‚Ä¢ ${migrationResults.cleaned} chaves removidas`);
                log('migration-log', `  ‚Ä¢ ${migrationResults.errors} erros encontrados`);
                
            } catch (error) {
                log('migration-log', `‚ùå Erro cr√≠tico na migra√ß√£o: ${error.message}`, 'error');
            }
        };
        
        // Simula√ß√£o de migra√ß√£o
        window.runMigrationDryRun = function() {
            clearLog('migration-log');
            log('migration-log', 'üß™ Executando simula√ß√£o (nenhuma altera√ß√£o ser√° feita)...');
            
            const actions = [];
            
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                
                if (key && key.startsWith('activeSkin_')) {
                    const userId = key.replace('activeSkin_', '');
                    const selectedSkinKey = `selectedSkin_${userId}`;
                    
                    try {
                        const activeData = JSON.parse(localStorage.getItem(key));
                        const existingSelected = localStorage.getItem(selectedSkinKey);
                        
                        if (!existingSelected) {
                            actions.push(`MIGRAR: ${key} ‚Üí ${selectedSkinKey} (${activeData.skinId})`);
                        } else {
                            actions.push(`MANTER: ${selectedSkinKey} j√° existe`);
                        }
                        
                        actions.push(`REMOVER: ${key}`);
                        
                    } catch (error) {
                        actions.push(`REMOVER: ${key} (dados corrompidos)`);
                    }
                }
            }
            
            log('migration-log', `üìã A√ß√µes que seriam executadas:`);
            actions.forEach(action => {
                log('migration-log', `  ‚Ä¢ ${action}`);
            });
            
            log('migration-log', `\nüìä Total: ${actions.length} a√ß√µes`);
        };
        
        // Limpeza manual
        window.clearAllActiveSkins = function() {
            if (!confirm('‚ö†Ô∏è Tem certeza? Isso remover√° TODOS os dados de activeSkin_*')) {
                return;
            }
            
            clearLog('cleanup-log');
            log('cleanup-log', 'üóëÔ∏è Removendo todos os activeSkin_*...');
            
            let removed = 0;
            const keysToRemove = [];
            
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.startsWith('activeSkin_')) {
                    keysToRemove.push(key);
                }
            }
            
            keysToRemove.forEach(key => {
                localStorage.removeItem(key);
                log('cleanup-log', `üóëÔ∏è Removido: ${key}`);
                removed++;
            });
            
            log('cleanup-log', `‚úÖ ${removed} chaves activeSkin_* removidas`, 'success');
        };
        
        window.clearAllSkinData = function() {
            if (!confirm('‚ö†Ô∏è ATEN√á√ÉO! Isso remover√° TODOS os dados de skins. Tem certeza?')) {
                return;
            }
            
            clearLog('cleanup-log');
            log('cleanup-log', 'üóëÔ∏è Removendo TODOS os dados de skin...');
            
            let removed = 0;
            const keysToRemove = [];
            
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && (key.includes('Skin') || key.includes('skin'))) {
                    keysToRemove.push(key);
                }
            }
            
            keysToRemove.forEach(key => {
                localStorage.removeItem(key);
                log('cleanup-log', `üóëÔ∏è Removido: ${key}`);
                removed++;
            });
            
            log('cleanup-log', `‚úÖ ${removed} chaves de skin removidas`, 'success');
        };
        
        // Verifica√ß√£o p√≥s-migra√ß√£o
        window.verifyMigration = function() {
            clearLog('verification-log');
            log('verification-log', 'üîç Verificando integridade p√≥s-migra√ß√£o...');
            
            let activeSkinCount = 0;
            let selectedSkinCount = 0;
            let corruptedCount = 0;
            
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                
                if (key && key.startsWith('activeSkin_')) {
                    activeSkinCount++;
                    log('verification-log', `‚ö†Ô∏è activeSkin ainda existe: ${key}`, 'warning');
                }
                
                if (key && key.startsWith('selectedSkin_')) {
                    selectedSkinCount++;
                    
                    try {
                        const data = JSON.parse(localStorage.getItem(key));
                        if (data.skinId && data.skinFile) {
                            log('verification-log', `‚úÖ selectedSkin v√°lido: ${key} (${data.skinId})`, 'success');
                        } else {
                            log('verification-log', `‚ùå selectedSkin inv√°lido: ${key}`, 'error');
                            corruptedCount++;
                        }
                    } catch (error) {
                        log('verification-log', `‚ùå selectedSkin corrompido: ${key}`, 'error');
                        corruptedCount++;
                    }
                }
            }
            
            log('verification-log', `\nüìä Resultado da Verifica√ß√£o:`);
            log('verification-log', `  ‚Ä¢ activeSkin_* restantes: ${activeSkinCount}`);
            log('verification-log', `  ‚Ä¢ selectedSkin_* v√°lidos: ${selectedSkinCount - corruptedCount}`);
            log('verification-log', `  ‚Ä¢ Dados corrompidos: ${corruptedCount}`);
            
            if (activeSkinCount === 0 && corruptedCount === 0) {
                log('verification-log', `\nüéâ MIGRA√á√ÉO CONCLU√çDA COM SUCESSO!`, 'success');
            } else {
                log('verification-log', `\n‚ö†Ô∏è Migra√ß√£o incompleta ou com problemas`, 'warning');
            }
        };
        
        // Inicializar
        log('analysis-log', 'üöÄ Sistema de migra√ß√£o inicializado');
        log('analysis-log', 'Clique em "Analisar Estado Atual" para come√ßar');
    </script>
</body>
</html>