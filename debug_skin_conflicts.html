<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug - Conflitos de Skins no localStorage</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #1a1a1a;
            color: #fff;
        }
        .section {
            background: #2a2a2a;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            border-left: 4px solid #4ECDC4;
        }
        .conflict {
            background: #4a2a2a;
            border-left-color: #ff6b6b;
        }
        .ok {
            background: #2a4a2a;
            border-left-color: #51cf66;
        }
        button {
            background: #4ECDC4;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #45b7aa;
        }
        .log {
            background: #000;
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        .user-info {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }
        .user-card {
            background: #333;
            padding: 15px;
            border-radius: 8px;
            min-width: 200px;
        }
    </style>
</head>
<body>
    <h1>üîç Debug - Conflitos de Skins no localStorage</h1>
    
    <div class="section">
        <h2>üéØ Objetivo</h2>
        <p>Identificar e resolver conflitos entre os campos <code>activeSkin_100</code> e <code>selectedSkin_100</code> no localStorage que podem estar causando erros no sistema de skins.</p>
    </div>

    <div class="section">
        <h2>üë§ Configura√ß√£o de Usu√°rio de Teste</h2>
        <button onclick="setupTestUser()">Criar Usu√°rio ID 100</button>
        <button onclick="clearAllSkinData()">Limpar Todos os Dados de Skin</button>
        <div id="user-setup-log" class="log"></div>
    </div>

    <div class="section">
        <h2>üìä An√°lise do localStorage</h2>
        <button onclick="analyzeLocalStorage()">Analisar localStorage</button>
        <button onclick="showAllSkinKeys()">Mostrar Todas as Chaves de Skin</button>
        <div id="analysis-log" class="log"></div>
    </div>

    <div class="section">
        <h2>üîß Simula√ß√£o de Conflitos</h2>
        <button onclick="createConflictScenario1()">Cen√°rio 1: activeSkin ‚â† selectedSkin</button>
        <button onclick="createConflictScenario2()">Cen√°rio 2: Dados Corrompidos</button>
        <button onclick="createConflictScenario3()">Cen√°rio 3: M√∫ltiplas Vers√µes</button>
        <div id="conflict-log" class="log"></div>
    </div>

    <div class="section">
        <h2>üß™ Teste de Carregamento</h2>
        <button onclick="testPlayerSkinLoading()">Testar Player.loadUserSelectedSkin()</button>
        <button onclick="testShopSkinLoading()">Testar Shop.getActiveSkin()</button>
        <div id="loading-test-log" class="log"></div>
    </div>

    <div class="section">
        <h2>‚úÖ Propostas de Corre√ß√£o</h2>
        <button onclick="proposeUnifiedSystem()">Propor Sistema Unificado</button>
        <button onclick="implementFix()">Implementar Corre√ß√£o</button>
        <div id="fix-log" class="log"></div>
    </div>

    <!-- Scripts carregados apenas se necess√°rio para evitar conflitos de m√≥dulos -->
    
    <script>
        const testUserId = 100;
        
        function log(elementId, message) {
            const element = document.getElementById(elementId);
            element.textContent += new Date().toLocaleTimeString() + ' - ' + message + '\n';
            element.scrollTop = element.scrollHeight;
        }
        
        function clearLog(elementId) {
            document.getElementById(elementId).textContent = '';
        }
        
        // Configurar usu√°rio de teste
        window.setupTestUser = function() {
            clearLog('user-setup-log');
            log('user-setup-log', 'üöÄ Configurando usu√°rio de teste ID 100...');
            
            try {
                const testUser = {
                    id: testUserId,
                    name: 'Usu√°rio Teste',
                    email: 'teste@teste.com',
                    coins: 1000
                };
                
                localStorage.setItem('currentUser', JSON.stringify(testUser));
                localStorage.setItem('spaceInvaders_currentUser', JSON.stringify(testUser));
                localStorage.setItem('isLoggedIn', 'true');
                
                log('user-setup-log', '‚úÖ Usu√°rio criado com sucesso');
                log('user-setup-log', `üìã ID: ${testUser.id}`);
                log('user-setup-log', `üìã Nome: ${testUser.name}`);
                
            } catch (error) {
                log('user-setup-log', '‚ùå Erro: ' + error.message);
            }
        };
        
        // Limpar todos os dados de skin
        window.clearAllSkinData = function() {
            clearLog('user-setup-log');
            log('user-setup-log', 'üßπ Limpando todos os dados de skin...');
            
            try {
                const keysToRemove = [];
                
                // Encontrar todas as chaves relacionadas a skins
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key && (key.includes('Skin') || key.includes('skin'))) {
                        keysToRemove.push(key);
                    }
                }
                
                // Remover as chaves
                keysToRemove.forEach(key => {
                    localStorage.removeItem(key);
                    log('user-setup-log', `üóëÔ∏è Removido: ${key}`);
                });
                
                log('user-setup-log', `‚úÖ ${keysToRemove.length} chaves de skin removidas`);
                
            } catch (error) {
                log('user-setup-log', '‚ùå Erro: ' + error.message);
            }
        };
        
        // Analisar localStorage
        window.analyzeLocalStorage = function() {
            clearLog('analysis-log');
            log('analysis-log', 'üîç Analisando localStorage...');
            
            try {
                const skinKeys = [];
                const conflicts = [];
                
                // Encontrar todas as chaves de skin
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key && (key.includes('Skin') || key.includes('skin'))) {
                        skinKeys.push(key);
                    }
                }
                
                log('analysis-log', `üìä Encontradas ${skinKeys.length} chaves relacionadas a skins:`);
                
                skinKeys.forEach(key => {
                    const value = localStorage.getItem(key);
                    log('analysis-log', `  ${key}: ${value}`);
                    
                    // Verificar se √© JSON v√°lido
                    try {
                        JSON.parse(value);
                        log('analysis-log', `    ‚úÖ JSON v√°lido`);
                    } catch {
                        log('analysis-log', `    ‚ùå JSON inv√°lido`);
                        conflicts.push(`${key}: JSON inv√°lido`);
                    }
                });
                
                // Verificar conflitos espec√≠ficos para usu√°rio 100
                const activeSkin = localStorage.getItem(`activeSkin_${testUserId}`);
                const selectedSkin = localStorage.getItem(`selectedSkin_${testUserId}`);
                
                if (activeSkin && selectedSkin) {
                    try {
                        const activeData = JSON.parse(activeSkin);
                        const selectedData = JSON.parse(selectedSkin);
                        
                        if (activeData.skinId !== selectedData.skinId) {
                            conflicts.push('activeSkin e selectedSkin t√™m IDs diferentes');
                            log('analysis-log', `‚ö†Ô∏è CONFLITO: activeSkin=${activeData.skinId}, selectedSkin=${selectedData.skinId}`);
                        } else {
                            log('analysis-log', `‚úÖ activeSkin e selectedSkin est√£o sincronizados`);
                        }
                    } catch (error) {
                        conflicts.push('Erro ao comparar activeSkin e selectedSkin');
                    }
                }
                
                log('analysis-log', `\nüìã Resumo: ${conflicts.length} conflitos encontrados`);
                conflicts.forEach(conflict => {
                    log('analysis-log', `  ‚ùå ${conflict}`);
                });
                
            } catch (error) {
                log('analysis-log', '‚ùå Erro na an√°lise: ' + error.message);
            }
        };
        
        // Mostrar todas as chaves de skin
        window.showAllSkinKeys = function() {
            clearLog('analysis-log');
            log('analysis-log', 'üîë Todas as chaves do localStorage:');
            
            const allKeys = [];
            for (let i = 0; i < localStorage.length; i++) {
                allKeys.push(localStorage.key(i));
            }
            
            allKeys.sort().forEach(key => {
                const isSkinRelated = key.includes('Skin') || key.includes('skin');
                const prefix = isSkinRelated ? 'üé®' : 'üìÑ';
                log('analysis-log', `${prefix} ${key}`);
            });
        };
        
        // Criar cen√°rios de conflito
        window.createConflictScenario1 = function() {
            clearLog('conflict-log');
            log('conflict-log', 'üîß Criando Cen√°rio 1: activeSkin ‚â† selectedSkin');
            
            const activeSkin = {
                skinId: 'skin_milenium',
                skinFile: 'milenium.png',
                setAt: new Date().toISOString()
            };
            
            const selectedSkin = {
                skinId: 'skin_xwing',
                skinFile: 'xwing.png',
                skinName: 'X-Wing Fighter'
            };
            
            localStorage.setItem(`activeSkin_${testUserId}`, JSON.stringify(activeSkin));
            localStorage.setItem(`selectedSkin_${testUserId}`, JSON.stringify(selectedSkin));
            
            log('conflict-log', '‚úÖ Conflito criado:');
            log('conflict-log', `  activeSkin: ${activeSkin.skinId}`);
            log('conflict-log', `  selectedSkin: ${selectedSkin.skinId}`);
        };
        
        window.createConflictScenario2 = function() {
            clearLog('conflict-log');
            log('conflict-log', 'üîß Criando Cen√°rio 2: Dados Corrompidos');
            
            // JSON inv√°lido
            localStorage.setItem(`activeSkin_${testUserId}`, '{"skinId":"skin_test","skinFile":}');
            localStorage.setItem(`selectedSkin_${testUserId}`, 'skin_invalid_format');
            
            log('conflict-log', '‚úÖ Dados corrompidos criados');
        };
        
        window.createConflictScenario3 = function() {
            clearLog('conflict-log');
            log('conflict-log', 'üîß Criando Cen√°rio 3: M√∫ltiplas Vers√µes');
            
            // Criar m√∫ltiplas vers√µes com formatos diferentes
            localStorage.setItem(`activeSkin_${testUserId}`, JSON.stringify({
                skinId: 'skin_blue',
                skinFile: 'blue.png',
                setAt: new Date().toISOString()
            }));
            
            localStorage.setItem(`selectedSkin_${testUserId}`, JSON.stringify({
                id: 'skin_blue', // formato diferente (id vs skinId)
                file: 'blue.png', // formato diferente (file vs skinFile)
                name: 'Nave Azul'
            }));
            
            // Vers√µes antigas
            localStorage.setItem(`userSkin_${testUserId}`, 'skin_old_format');
            localStorage.setItem(`currentSkin_${testUserId}`, 'skin_legacy');
            
            log('conflict-log', '‚úÖ M√∫ltiplas vers√µes criadas');
        };
        
        // Testar carregamento
        window.testPlayerSkinLoading = function() {
            clearLog('loading-test-log');
            log('loading-test-log', 'üß™ Testando Player.loadUserSelectedSkin()...');
            
            try {
                // Simular o comportamento do Player
                const currentUser = JSON.parse(localStorage.getItem('spaceInvaders_currentUser') || 'null');
                log('loading-test-log', `üë§ Usu√°rio encontrado: ${currentUser ? currentUser.name : 'Nenhum'}`);
                
                if (currentUser) {
                    const selectedSkinData = localStorage.getItem(`selectedSkin_${currentUser.id}`);
                    log('loading-test-log', `üé® selectedSkin encontrada: ${selectedSkinData ? 'Sim' : 'N√£o'}`);
                    
                    if (selectedSkinData) {
                        try {
                            const skinData = JSON.parse(selectedSkinData);
                            log('loading-test-log', `üìã Dados da skin: ${JSON.stringify(skinData, null, 2)}`);
                            
                            if (skinData.skinFile) {
                                log('loading-test-log', `‚úÖ Skin v√°lida: ${skinData.skinName || skinData.skinId}`);
                            } else {
                                log('loading-test-log', `‚ùå Skin inv√°lida: falta skinFile`);
                            }
                        } catch (error) {
                            log('loading-test-log', `‚ùå Erro ao parsear JSON: ${error.message}`);
                        }
                    }
                }
                
            } catch (error) {
                log('loading-test-log', '‚ùå Erro no teste: ' + error.message);
            }
        };
        
        window.testShopSkinLoading = function() {
            clearLog('loading-test-log');
            log('loading-test-log', 'üß™ Testando Shop.getActiveSkin()...');
            
            try {
                const currentUser = JSON.parse(localStorage.getItem('currentUser') || 'null');
                log('loading-test-log', `üë§ Usu√°rio encontrado: ${currentUser ? currentUser.name : 'Nenhum'}`);
                
                if (currentUser) {
                    const activeSkinData = localStorage.getItem(`activeSkin_${currentUser.id}`);
                    log('loading-test-log', `üöÄ activeSkin encontrada: ${activeSkinData ? 'Sim' : 'N√£o'}`);
                    
                    if (activeSkinData) {
                        try {
                            const skinData = JSON.parse(activeSkinData);
                            log('loading-test-log', `üìã Dados da skin: ${JSON.stringify(skinData, null, 2)}`);
                        } catch (error) {
                            log('loading-test-log', `‚ùå Erro ao parsear JSON: ${error.message}`);
                        }
                    }
                }
                
            } catch (error) {
                log('loading-test-log', '‚ùå Erro no teste: ' + error.message);
            }
        };
        
        // Propor sistema unificado
        window.proposeUnifiedSystem = function() {
            clearLog('fix-log');
            log('fix-log', 'üí° Proposta de Sistema Unificado:');
            log('fix-log', '');
            log('fix-log', '1. USAR APENAS selectedSkin_[userId]:');
            log('fix-log', '   - Formato padr√£o: {skinId, skinFile, skinName, selectedAt}');
            log('fix-log', '   - Player.js carrega apenas desta fonte');
            log('fix-log', '   - shop.js salva apenas nesta chave');
            log('fix-log', '');
            log('fix-log', '2. REMOVER activeSkin_[userId]:');
            log('fix-log', '   - Eliminar redund√¢ncia');
            log('fix-log', '   - Evitar conflitos de sincroniza√ß√£o');
            log('fix-log', '');
            log('fix-log', '3. MIGRA√á√ÉO:');
            log('fix-log', '   - Verificar se existe activeSkin sem selectedSkin');
            log('fix-log', '   - Migrar dados para selectedSkin');
            log('fix-log', '   - Limpar activeSkin ap√≥s migra√ß√£o');
            log('fix-log', '');
            log('fix-log', '4. VALIDA√á√ÉO:');
            log('fix-log', '   - Verificar JSON v√°lido antes de usar');
            log('fix-log', '   - Fallback para skin padr√£o em caso de erro');
        };
        
        // Implementar corre√ß√£o
        window.implementFix = function() {
            clearLog('fix-log');
            log('fix-log', 'üîß Implementando corre√ß√£o...');
            
            try {
                const currentUser = JSON.parse(localStorage.getItem('currentUser') || 'null');
                if (!currentUser) {
                    log('fix-log', '‚ùå Usu√°rio n√£o encontrado');
                    return;
                }
                
                const userId = currentUser.id;
                const activeSkinKey = `activeSkin_${userId}`;
                const selectedSkinKey = `selectedSkin_${userId}`;
                
                const activeSkinData = localStorage.getItem(activeSkinKey);
                const selectedSkinData = localStorage.getItem(selectedSkinKey);
                
                log('fix-log', `üîç Verificando dados para usu√°rio ${userId}:`);
                log('fix-log', `  activeSkin: ${activeSkinData ? 'Existe' : 'N√£o existe'}`);
                log('fix-log', `  selectedSkin: ${selectedSkinData ? 'Existe' : 'N√£o existe'}`);
                
                // Cen√°rio 1: Existe activeSkin mas n√£o selectedSkin
                if (activeSkinData && !selectedSkinData) {
                    try {
                        const activeData = JSON.parse(activeSkinData);
                        const migratedData = {
                            skinId: activeData.skinId,
                            skinFile: activeData.skinFile,
                            skinName: activeData.skinName || activeData.skinId,
                            selectedAt: activeData.setAt || new Date().toISOString()
                        };
                        
                        localStorage.setItem(selectedSkinKey, JSON.stringify(migratedData));
                        localStorage.removeItem(activeSkinKey);
                        
                        log('fix-log', '‚úÖ Migra√ß√£o: activeSkin ‚Üí selectedSkin');
                        log('fix-log', `   Skin: ${migratedData.skinId}`);
                    } catch (error) {
                        log('fix-log', '‚ùå Erro na migra√ß√£o: ' + error.message);
                        localStorage.removeItem(activeSkinKey);
                    }
                }
                
                // Cen√°rio 2: Existem ambos - manter selectedSkin, remover activeSkin
                else if (activeSkinData && selectedSkinData) {
                    localStorage.removeItem(activeSkinKey);
                    log('fix-log', '‚úÖ Remo√ß√£o: activeSkin removido (selectedSkin mantido)');
                }
                
                // Cen√°rio 3: S√≥ existe selectedSkin - OK
                else if (selectedSkinData) {
                    log('fix-log', '‚úÖ OK: Apenas selectedSkin existe');
                }
                
                // Cen√°rio 4: Nenhum existe - OK (skin padr√£o)
                else {
                    log('fix-log', '‚úÖ OK: Nenhuma skin personalizada (usando padr√£o)');
                }
                
                log('fix-log', '');
                log('fix-log', 'üéâ Corre√ß√£o implementada com sucesso!');
                
            } catch (error) {
                log('fix-log', '‚ùå Erro na implementa√ß√£o: ' + error.message);
            }
        };
        
        // Inicializar
        log('user-setup-log', 'üöÄ Sistema de debug inicializado');
        log('user-setup-log', 'Configure um usu√°rio de teste para come√ßar');
    </script>
</body>
</html>