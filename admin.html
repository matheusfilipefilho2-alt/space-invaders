<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Space Invaders</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="style.css">

</head>
<body class="admin-page">
    <!-- Fundo de estrelas -->
    <canvas id="stars-background"></canvas>

    <div class="admin-container">
        <!-- Header -->
        <div class="admin-header">
            <h1 class="admin-title">üöÄ ADMIN DASHBOARD</h1>
            <p style="font-size: 10px; color: #888;">Sistema de Administra√ß√£o - Space Invaders v1.5</p>
            <div style="margin-top: 15px;">
                <span id="server-status" class="server-status">üü¢ Online</span>
                <span style="margin: 0 15px;">|</span>
                <span id="last-update">√öltima atualiza√ß√£o: --:--</span>
            </div>
        </div>

        <!-- Bot√µes de A√ß√£o -->
        <div class="action-buttons">
            <button class="admin-btn primary" onclick="refreshDashboard()">üîÑ ATUALIZAR</button>
            <button class="admin-btn success" onclick="exportData()">üì§ EXPORTAR</button>
            <button class="admin-btn warning" onclick="showSystemConfig()">‚öôÔ∏è CONFIGURA√á√ïES</button>
            <button class="admin-btn danger" onclick="showSecurityLogs()">üõ°Ô∏è SEGURAN√áA</button>
        </div>

        <!-- Cards do Dashboard -->
        <div class="dashboard-grid">
            <!-- Estat√≠sticas Gerais -->
            <div class="dashboard-card stats">
                <div class="card-title" style="color: #4ECDC4;">
                    üìä ESTAT√çSTICAS GERAIS
                </div>
                <div class="stat-grid">
                    <div class="stat-item">
                        <div class="stat-value" id="total-players">0</div>
                        <div class="stat-label">Jogadores Totais</div>
                        <div class="metric-trend" id="players-trend">--</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="active-players">0</div>
                        <div class="stat-label">Ativos (24h)</div>
                        <div class="metric-trend" id="active-trend">--</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="total-games">0</div>
                        <div class="stat-label">Partidas Jogadas</div>
                        <div class="metric-trend" id="games-trend">--</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="avg-score">0</div>
                        <div class="stat-label">Score M√©dio</div>
                        <div class="metric-trend" id="score-trend">--</div>
                    </div>
                </div>
                
                <div class="chart-container">
                    <canvas id="playersChart"></canvas>
                </div>
            </div>

            <!-- Jogadores -->
            <div class="dashboard-card players">
                <div class="card-title" style="color: #FF6B6B;">
                    üë• TOP JOGADORES
                </div>
                <div class="players-table-container">
                    <table class="players-table" id="top-players-table">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Jogador</th>
                                <th>Score</th>
                                <th>N√≠vel</th>
                                <th>Moedas</th>
                                <th>√öltima</th>
                            </tr>
                        </thead>
                        <tbody id="top-players-body">
                            <tr><td colspan="6" class="loading">Carregando...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Sistema Econ√¥mico -->
            <div class="dashboard-card revenue">
                <div class="card-title" style="color: #FFD700;">
                    üí∞ ECONOMIA DO JOGO
                </div>
                <div class="stat-grid">
                    <div class="stat-item">
                        <div class="stat-value" id="total-coins">0</div>
                        <div class="stat-label">Moedas em Circula√ß√£o</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="shop-transactions">0</div>
                        <div class="stat-label">Transa√ß√µes na Loja</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="popular-item">--</div>
                        <div class="stat-label">Item Mais Popular</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="avg-coins-per-player">0</div>
                        <div class="stat-label">Moedas por Jogador</div>
                    </div>
                </div>

                <div class="chart-container">
                    <canvas id="economyChart"></canvas>
                </div>
            </div>

            <!-- Seguran√ßa -->
            <div class="dashboard-card security">
                <div class="card-title" style="color: #FF4757;">
                    üõ°Ô∏è SEGURAN√áA & ANTI-CHEAT
                </div>
                <div class="stat-grid">
                    <div class="stat-item">
                        <div class="stat-value" id="security-alerts">0</div>
                        <div class="stat-label">Alertas Ativos</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="blocked-users">0</div>
                        <div class="stat-label">Usu√°rios Bloqueados</div>
                    </div>
                </div>

                <div class="security-alerts" id="security-alerts-list">
                    <div class="loading">Carregando alertas...</div>
                </div>
            </div>
        </div>

        <!-- Gr√°ficos Adicionais -->
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 30px;">
            <div class="dashboard-card">
                <div class="card-title">üìà ENGAJAMENTO POR HORA</div>
                <div class="chart-container">
                    <canvas id="hourlyChart"></canvas>
                </div>
            </div>
            
            <div class="dashboard-card">
                <div class="card-title">üèÜ CONQUISTAS MAIS RARAS</div>
                <div class="chart-container">
                    <canvas id="achievementsChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para Configura√ß√µes -->
    <div class="modal" id="config-modal">
        <div class="modal-content">
            <h3>‚öôÔ∏è CONFIGURA√á√ïES DO SISTEMA</h3>
            <div id="config-content">
                <div class="loading">Carregando configura√ß√µes...</div>
            </div>
            <button class="admin-btn primary" onclick="closeModal('config-modal')">FECHAR</button>
        </div>
    </div>

    <!-- Modal para Logs de Seguran√ßa -->
    <div class="modal" id="security-modal">
        <div class="modal-content">
            <h3>üõ°Ô∏è LOGS DE SEGURAN√áA DETALHADOS</h3>
            <div id="security-content">
                <div class="loading">Carregando logs...</div>
            </div>
            <button class="admin-btn primary" onclick="closeModal('security-modal')">FECHAR</button>
        </div>
    </div>

    <!-- Scripts -->
    <script type="module">
        import Star from './src/classes/Star.js';

        // Fundo animado
        const canvas = document.getElementById('stars-background');
        const ctx = canvas.getContext('2d');
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        canvas.style.position = 'fixed';
        canvas.style.top = '0';
        canvas.style.left = '0';
        canvas.style.zIndex = '-1';
        canvas.style.background = 'linear-gradient(135deg, #050519 0%, #0a0a2e 50%, #16213e 100%)';

        const stars = [];
        for (let i = 0; i < 50; i++) {
            stars.push(new Star(canvas.width, canvas.height));
        }

        function animate() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = '#050519';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            stars.forEach(star => {
                star.update();
                star.draw(ctx);
            });

            requestAnimationFrame(animate);
        }
        animate();

        window.addEventListener('resize', () => {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        });
    </script>

    <script type="module">
        // Importar configura√ß√£o do Supabase
        import { supabase } from './src/supabase.js';
        
        console.log('üîß Cliente Supabase inicializado para admin dashboard');
        
        // Testar conex√£o com Supabase
        async function testSupabaseConnection() {
            try {
                console.log('üîç Testando conex√£o com Supabase...');
                
                // Teste mais simples - apenas verificar se o cliente foi criado
                if (!supabase) {
                    throw new Error('Cliente Supabase n√£o foi criado');
                }
                
                // Teste de conex√£o b√°sica
                const { data, error } = await supabase.from('players').select('id').limit(1);
                if (error) {
                    console.error('‚ùå Erro na conex√£o:', error);
                    console.error('Detalhes do erro:', JSON.stringify(error, null, 2));
                    return false;
                }
                console.log('‚úÖ Conex√£o com Supabase OK, dados:', data);
                return true;
            } catch (err) {
                console.error('‚ùå Erro ao testar conex√£o:', err);
                return false;
            }
        }

        // Vari√°veis globais
        let charts = {};

        // Inicializa√ß√£o
        document.addEventListener('DOMContentLoaded', () => {
            initializeDashboard();
            setInterval(refreshDashboard, 30000); // Atualizar a cada 30s
        });

        async function initializeDashboard() {
            console.log('üöÄ Inicializando dashboard admin...');
            await loadDashboardData();
            updateLastUpdateTime();
        }

        async function loadDashboardData() {
            try {
                // Testar conex√£o primeiro
                const connectionOk = await testSupabaseConnection();
                if (!connectionOk) {
                    throw new Error('Falha na conex√£o com Supabase');
                }
                
                // Carregar dados em paralelo
                const [
                    playersData,
                    gamesData,
                    securityData,
                    economyData
                ] = await Promise.all([
                    loadPlayersData(),
                    loadGamesData(),
                    loadSecurityData(),
                    loadEconomyData()
                ]);

                // Atualizar UI
                updateStatistics(playersData, gamesData, economyData);
                updateTopPlayers(playersData.topPlayers);
                updateSecurityAlerts(securityData);
                createCharts(playersData, gamesData, economyData);

                console.log('‚úÖ Dashboard carregado com sucesso');

            } catch (error) {
                console.error('‚ùå Erro ao carregar dashboard:', error);
                showError('Erro ao carregar dados do dashboard');
            }
        }

        async function loadPlayersData() {
            const { data: players, error } = await supabase
                .from('players')
                .select('*')
                .order('high_score', { ascending: false });

            if (error) throw error;

            const now = Date.now();
            const oneDayAgo = now - (24 * 60 * 60 * 1000);

            const activePlayers = players.filter(p => {
                const lastPlayed = new Date(p.last_played).getTime();
                return lastPlayed >= oneDayAgo;
            });

            return {
                total: players.length,
                active: activePlayers.length,
                topPlayers: players.slice(0, 10),
                players: players
            };
        }

        async function loadGamesData() {
            const { data: analytics, error } = await supabase
                .from('analytics_events')
                .select('*')
                .eq('event_name', 'game_end')
                .gte('timestamp', new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString());

            if (error) throw error;

            const totalGames = analytics.length;
            const averageScore = analytics.length > 0 ? 
                analytics.reduce((sum, game) => sum + (game.properties?.finalScore || 0), 0) / totalGames : 0;

            return {
                total: totalGames,
                averageScore: Math.round(averageScore),
                gamesData: analytics
            };
        }

        async function loadSecurityData() {
            const { data: logs, error } = await supabase
                .from('security_logs')
                .select('*')
                .order('timestamp', { ascending: false })
                .limit(20);

            if (error) throw error;

            const alerts = logs.filter(log => 
                log.security_report?.riskLevel >= 2
            );

            return {
                alerts: alerts.length,
                recentAlerts: alerts.slice(0, 5),
                blockedUsers: logs.filter(log => 
                    log.security_report?.isBlocked
                ).length
            };
        }

        async function loadEconomyData() {
            const { data: players, error } = await supabase
                .from('players')
                .select('coins');

            if (error) throw error;

            const totalCoins = players.reduce((sum, p) => sum + (p.coins || 0), 0);
            const avgCoinsPerPlayer = players.length > 0 ? totalCoins / players.length : 0;

            return {
                totalCoins,
                avgCoinsPerPlayer: Math.round(avgCoinsPerPlayer),
                transactions: 0, // Placeholder - implementar se necess√°rio
                popularItem: 'Theme Neon' // Placeholder
            };
        }

        function updateStatistics(playersData, gamesData, economyData) {
            document.getElementById('total-players').textContent = playersData.total;
            document.getElementById('active-players').textContent = playersData.active;
            document.getElementById('total-games').textContent = gamesData.total;
            document.getElementById('avg-score').textContent = gamesData.averageScore.toLocaleString();
            
            document.getElementById('total-coins').textContent = economyData.totalCoins.toLocaleString();
            document.getElementById('shop-transactions').textContent = economyData.transactions;
            document.getElementById('popular-item').textContent = economyData.popularItem;
            document.getElementById('avg-coins-per-player').textContent = economyData.avgCoinsPerPlayer;
        }

        function updateTopPlayers(topPlayers) {
            const tbody = document.getElementById('top-players-body');
            tbody.innerHTML = '';

            topPlayers.forEach((player, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${player.username}</td>
                    <td>${(player.high_score || 0).toLocaleString()}</td>
                    <td>${player.level_id || 1}</td>
                    <td>${(player.coins || 0).toLocaleString()}</td>
                    <td>${player.last_played ? new Date(player.last_played).toLocaleDateString('pt-BR') : 'Nunca'}</td>
                `;
                tbody.appendChild(row);
            });
        }

        function updateSecurityAlerts(securityData) {
            document.getElementById('security-alerts').textContent = securityData.alerts;
            document.getElementById('blocked-users').textContent = securityData.blockedUsers;

            const alertsList = document.getElementById('security-alerts-list');
            alertsList.innerHTML = '';

            if (securityData.recentAlerts.length === 0) {
                alertsList.innerHTML = '<div style="text-align: center; color: #00ff88;">‚úÖ Nenhum alerta ativo</div>';
                return;
            }

            securityData.recentAlerts.forEach(alert => {
                const alertDiv = document.createElement('div');
                alertDiv.className = 'alert-item';
                alertDiv.innerHTML = `
                    <div><strong>${alert.username}</strong> - Risco: ${getRiskLevel(alert.security_report?.riskLevel)}</div>
                    <div style="margin: 5px 0;">${alert.security_report?.flaggedBehaviors?.[0]?.description || 'Comportamento suspeito'}</div>
                    <div class="alert-time">${new Date(alert.timestamp).toLocaleString('pt-BR')}</div>
                `;
                alertsList.appendChild(alertDiv);
            });
        }

        function getRiskLevel(level) {
            const levels = {
                0: 'üü¢ Baixo',
                1: 'üü° M√©dio', 
                2: 'üü† Alto',
                3: 'üî¥ Cr√≠tico'
            };
            return levels[level] || '‚ùì Desconhecido';
        }

        function createCharts(playersData, gamesData, economyData) {
            // Gr√°fico de jogadores ao longo do tempo
            createPlayersChart();
            
            // Gr√°fico da economia
            createEconomyChart(economyData);
            
            // Gr√°fico de engajamento por hora
            createHourlyChart(gamesData);
            
            // Gr√°fico de conquistas
            createAchievementsChart();
        }

        function createPlayersChart() {
            const ctx = document.getElementById('playersChart').getContext('2d');
            
            // Dados simulados - em produ√ß√£o, buscar dados reais
            const data = {
                labels: ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun'],
                datasets: [{
                    label: 'Novos Jogadores',
                    data: [12, 19, 8, 25, 22, 15],
                    borderColor: '#4ECDC4',
                    backgroundColor: 'rgba(78, 205, 196, 0.1)',
                    borderWidth: 2,
                    fill: true
                }]
            };

            if (charts.players) charts.players.destroy();
            charts.players = new Chart(ctx, {
                type: 'line',
                data: data,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: { 
                            beginAtZero: true,
                            ticks: { color: '#888' },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        },
                        x: { 
                            ticks: { color: '#888' },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        }
                    }
                }
            });
        }

        function createEconomyChart(economyData) {
            const ctx = document.getElementById('economyChart').getContext('2d');
            
            const data = {
                labels: ['Temas', 'Boosts', 'Cosm√©ticos', 'Utilit√°rios'],
                datasets: [{
                    data: [35, 25, 30, 10],
                    backgroundColor: [
                        '#FF6B6B',
                        '#4ECDC4', 
                        '#FFD700',
                        '#9C27B0'
                    ]
                }]
            };

            if (charts.economy) charts.economy.destroy();
            charts.economy = new Chart(ctx, {
                type: 'doughnut',
                data: data,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { color: '#888' }
                        }
                    }
                }
            });
        }

        function createHourlyChart(gamesData) {
            const ctx = document.getElementById('hourlyChart').getContext('2d');
            
            // Processar dados por hora
            const hourlyData = new Array(24).fill(0);
            gamesData.gamesData?.forEach(game => {
                const hour = new Date(game.timestamp).getHours();
                hourlyData[hour]++;
            });

            const data = {
                labels: Array.from({length: 24}, (_, i) => `${i}:00`),
                datasets: [{
                    label: 'Partidas por Hora',
                    data: hourlyData,
                    borderColor: '#FFD700',
                    backgroundColor: 'rgba(255, 215, 0, 0.1)',
                    borderWidth: 2,
                    fill: true
                }]
            };

            if (charts.hourly) charts.hourly.destroy();
            charts.hourly = new Chart(ctx, {
                type: 'line',
                data: data,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: { 
                            beginAtZero: true,
                            ticks: { color: '#888' },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        },
                        x: { 
                            ticks: { color: '#888' },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        }
                    }
                }
            });
        }

        function createAchievementsChart() {
            const ctx = document.getElementById('achievementsChart').getContext('2d');
            
            const data = {
                labels: ['Primeira Partida', 'Mil Pontos', 'Veterano', 'Ace Pilot', 'Destruidor'],
                datasets: [{
                    label: '% de Jogadores',
                    data: [95, 78, 45, 23, 12],
                    backgroundColor: [
                        'rgba(78, 205, 196, 0.8)',
                        'rgba(255, 107, 107, 0.8)',
                        'rgba(255, 215, 0, 0.8)',
                        'rgba(156, 39, 176, 0.8)',
                        'rgba(255, 152, 0, 0.8)'
                    ]
                }]
            };

            if (charts.achievements) charts.achievements.destroy();
            charts.achievements = new Chart(ctx, {
                type: 'bar',
                data: data,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: { 
                            beginAtZero: true,
                            max: 100,
                            ticks: { 
                                color: '#888',
                                callback: function(value) {
                                    return value + '%';
                                }
                            },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        },
                        x: { 
                            ticks: { color: '#888' },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        }
                    }
                }
            });
        }

        function updateLastUpdateTime() {
            document.getElementById('last-update').textContent = 
                `√öltima atualiza√ß√£o: ${new Date().toLocaleTimeString('pt-BR')}`;
        }

        // Fun√ß√µes dos bot√µes
        function refreshDashboard() {
            console.log('üîÑ Atualizando dashboard...');
            loadDashboardData();
        }

        function exportData() {
            alert('üì§ Funcionalidade de exporta√ß√£o em desenvolvimento');
        }

        function showSystemConfig() {
            document.getElementById('config-modal').style.display = 'flex';
            // Carregar configura√ß√µes reais aqui
        }

        function showSecurityLogs() {
            document.getElementById('security-modal').style.display = 'flex';
            // Carregar logs detalhados aqui
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        function showError(message) {
            // Implementar notifica√ß√£o de erro
            console.error(message);
        }

        // Disponibilizar fun√ß√µes globalmente
        window.refreshDashboard = refreshDashboard;
        window.exportData = exportData;
        window.showSystemConfig = showSystemConfig;
        window.showSecurityLogs = showSecurityLogs;
        window.closeModal = closeModal;
    </script>
</body>
</html>